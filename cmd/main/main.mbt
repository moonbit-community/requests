///|
/// Comprehensive demo program for MoonBit requests library
fn main {
  @async.with_event_loop(fn(_) {
    try {
      println("ðŸš€ MoonBit Requests Library Demo")

      // Basic GET request
      println("\nðŸ“¡ 1. Basic GET Request")
      let response = @allwefantasy/requests.get(
        "https://httpbin.org/get",
        None,
        None,
      )
      println("   Status: \{response.status_code} \{response.reason}")
      println("   Success: \{response.ok()}")

      // GET with query parameters
      println("\nðŸ“¡ 2. GET with Query Parameters")
      let params = [
        ("lang", "moonbit"),
        ("version", "0.1"),
        ("special", "hello world!@#"),
      ]
      let param_response = @allwefantasy/requests.get(
        "https://httpbin.org/get",
        Some(params),
        None,
      )
      println("   Status: \{param_response.status_code}")
      println("   URL parameters properly encoded for special characters")

      // POST with JSON
      println("\nðŸ“¡ 3. POST with JSON Data")
      let json_data : Json = {
        "message": "Hello from MoonBit!",
        "timestamp": "2024-01-01",
      }
      let post_response = @allwefantasy/requests.post(
        "https://httpbin.org/post",
        None,
        Some(json_data),
        None,
      )
      println("   Status: \{post_response.status_code}")

      // POST with form data
      println("\nðŸ“¡ 4. POST with Form Data")
      let form_data = [("username", "moonbit"), ("action", "demo")]
      let form_response = @allwefantasy/requests.post(
        "https://httpbin.org/post",
        Some(form_data),
        None,
        None,
      )
      println("   Status: \{form_response.status_code}")

      // Custom headers
      println("\nðŸ“¡ 5. Request with Custom Headers")
      let headers = [("User-Agent", "MoonBit-Requests/1.0"), ("X-Demo", "true")]
      let header_response = @allwefantasy/requests.get(
        "https://httpbin.org/headers",
        None,
        Some(headers),
      )
      println("   Status: \{header_response.status_code}")

      // Basic Authentication  
      println("\nðŸ” 6. Basic Authentication")
      let auth = @allwefantasy/requests.basic_auth("user", "passwd")
      let (auth_header_name, auth_header_value) = auth.to_header()
      let auth_headers = [(auth_header_name, auth_header_value)]
      let auth_response = @allwefantasy/requests.get(
        "https://httpbin.org/basic-auth/user/passwd",
        None,
        Some(auth_headers),
      )
      println("   Auth Status: \{auth_response.status_code}")

      // Session usage
      println("\nðŸ“‹ 7. Session Usage")
      let session = @allwefantasy/requests.Session::new()
      let session_response = session.get(
        "https://httpbin.org/user-agent",
        None,
        None,
      )
      println("   Session Status: \{session_response.status_code}")

      // Error handling
      println("\nâŒ 8. Error Handling (404)")
      let error_response = @allwefantasy/requests.get(
        "https://httpbin.org/status/404",
        None,
        None,
      )
      println("   Error Status: \{error_response.status_code}")
      println("   Is OK: \{error_response.ok()}")
      try {
        error_response.raise_for_status()
        println("   This should not print")
      } catch {
        @allwefantasy/requests.RequestError::HTTPError(code, reason, _url) =>
          println("   âœ… Caught expected HTTP error: \{code} \{reason}")
        @allwefantasy/requests.RequestError::ConnectionError(msg) =>
          println("   Connection error: \{msg}")
        @allwefantasy/requests.RequestError::Timeout(msg) =>
          println("   Timeout error: \{msg}")
        @allwefantasy/requests.RequestError::URLError(msg) =>
          println("   URL error: \{msg}")
        @allwefantasy/requests.RequestError::TooManyRedirects(msg) =>
          println("   Too many redirects: \{msg}")
        @allwefantasy/requests.RequestError::SSLError(msg) =>
          println("   SSL error: \{msg}")
        @allwefantasy/requests.RequestError::ContentDecodingError(msg) =>
          println("   Content decoding error: \{msg}")
      }

      println("\nðŸµ 8.1 418 I'm a teapot")
      let teapot = @allwefantasy/requests.get(
        "https://httpbin.org/status/418",
        None,
        None,
      )
      println("   Status: \{teapot.status_code} \{teapot.reason}")
      println("   OK?: \{teapot.ok()}")

      let tea_body = teapot.text()
      let preview =
        if tea_body.length() > 200 { tea_body.substring(start=0, end=200) + "..." }
        else { tea_body }
      println("   Body preview:\n\{preview}")

      // Test URL validation and new error types
      println("\nðŸ› ï¸ 10. Enhanced Error Handling Test")

      // Test URL validation
      let invalid_url_error = try? @allwefantasy/requests.get(
          "invalid-url-format",
          None,
          None,
        )
      match invalid_url_error {
        Err(@allwefantasy/requests.RequestError::URLError(msg)) =>
          println("   âœ… Caught URL validation error: \{msg}")
        _ => println("   URL validation test failed")
      }

      // Test connection error
      try {
        let _invalid_response = @allwefantasy/requests.get(
          "http://invalid-domain-that-does-not-exist.com",
          None,
          None,
        )

      } catch {
        @allwefantasy/requests.RequestError::ConnectionError(msg) =>
          println("   âœ… Caught connection error: \{msg}")
        @allwefantasy/requests.RequestError::URLError(msg) =>
          println("   âœ… Caught URL error: \{msg}")
        @allwefantasy/requests.RequestError::HTTPError(code, reason, url) =>
          println("   HTTP error \{code}: \{reason} for \{url}")
        @allwefantasy/requests.RequestError::Timeout(msg) =>
          println("   Timeout error: \{msg}")
        @allwefantasy/requests.RequestError::TooManyRedirects(msg) =>
          println("   Too many redirects: \{msg}")
        @allwefantasy/requests.RequestError::SSLError(msg) =>
          println("   SSL error: \{msg}")
        @allwefantasy/requests.RequestError::ContentDecodingError(msg) =>
          println("   Content decoding error: \{msg}")
        _ => println("   Other error occurred")
      }
      // Additional HTTP Methods
      println("\nðŸ“¡ 9. Additional HTTP Methods")

      // HEAD request (won't have response body)
      let head_response = @allwefantasy/requests.head(
        "https://httpbin.org/get",
        None,
        None,
      )
      println("   HEAD Status: \{head_response.status_code}")
      println("   HEAD Content Length: \{head_response.content.length()}")

      // OPTIONS request
      let options_response = @allwefantasy/requests.options(
        "https://httpbin.org/",
        None,
      )
      println("   OPTIONS Status: \{options_response.status_code}")

      // PATCH request with JSON
      let patch_data : Json = {
        "update": "patch request",
        "timestamp": "2024-01-01",
      }
      let patch_response = @allwefantasy/requests.patch(
        "https://httpbin.org/patch",
        None,
        Some(patch_data),
        None,
      )
      println("   PATCH Status: \{patch_response.status_code}")
      // Demonstrate timeout functionality
      println("\nâ±ï¸ 11. Timeout Support")
      try {
        // Request with a 5-second timeout
        let timeout_response = @allwefantasy/requests.get(
          "https://httpbin.org/delay/1",
          None,
          None,
          timeout_ms=Some(5000),
        )
        println("   Timeout request Status: \{timeout_response.status_code}")
      } catch {
        @allwefantasy/requests.RequestError::Timeout(msg) =>
          println("   âœ… Timeout test: \{msg}")
        _ => println("   Timeout test completed")
      }

      // Demonstrate session with default timeout
      println("\nðŸ“‹ 12. Session with Default Timeout")
      let timeout_session = @allwefantasy/requests.Session::with_timeout(10000)
      try {
        let session_timeout_response = timeout_session.get(
          "https://httpbin.org/delay/1",
          None,
          None,
        )
        println(
          "   Session timeout Status: \{session_timeout_response.status_code}",
        )
      } catch {
        _ => println("   Session timeout test completed")
      }

      // Demonstrate cookie parsing
      println("\nðŸª 13. Cookie Parsing and Handling")
      try {
        let cookie_response = @allwefantasy/requests.get(
          "https://httpbin.org/cookies/set/demo_cookie/demo_value",
          None,
          None,
        )
        println("   Cookie response Status: \{cookie_response.status_code}")

        // Try to get a cookie value
        match cookie_response.cookies.get("demo_cookie") {
          Some(value) => println("   âœ… Parsed cookie: demo_cookie = \{value}")
          None => println("   No demo_cookie found in response")
        }
      } catch {
        _ => println("   Cookie test completed")
      }

      // Demonstrate response object features
      println("\nðŸ“Š 14. Response Object Features")
      try {
        let json_response = @allwefantasy/requests.get(
          "https://httpbin.org/json",
          None,
          None,
        )
        println("   JSON response Status: \{json_response.status_code}")
        println("   Response OK: \{json_response.ok()}")

        // Test JSON parsing
        let _json_data = json_response.json()
        println("   âœ… JSON parsed successfully")

        // Test response text
        let text_content = json_response.text()
        println("   Response text length: \{text_content.length()} characters")
      } catch {
        @allwefantasy/requests.RequestError::ContentDecodingError(msg) =>
          println("   Content decoding issue: \{msg}")
        _ => println("   Response features test completed")
      }

      // Demonstrate enhanced URL handling
      println("\nðŸ”— 15. Enhanced URL Handling")
      let special_params = [
        ("search", "hello world"),
        ("filter", "price>100"),
        ("unicode", "æµ‹è¯•"),
      ]
      try {
        let encoded_response = @allwefantasy/requests.get(
          "https://httpbin.org/get",
          Some(special_params),
          None,
        )
        println("   URL encoding Status: \{encoded_response.status_code}")
        println("   âœ… Special characters in URL parameters handled correctly")
      } catch {
        _ => println("   URL encoding test completed")
      }
      println("\nðŸŽ‰ All MoonBit Requests features demonstrated successfully!")
      println("âœ¨ Features showcased:")
      println(
        "   â€¢ Basic HTTP methods (GET, POST, PUT, HEAD, OPTIONS, PATCH)",
      )
      println("   â€¢ Query parameters with URL encoding")
      println("   â€¢ JSON and form data support")
      println("   â€¢ Custom headers")
      println("   â€¢ Basic authentication")
      println("   â€¢ Session management with persistent settings")
      println("   â€¢ â±ï¸ Timeout support for all requests")
      println("   â€¢ ðŸª Comprehensive cookie parsing and handling")
      println("   â€¢ ðŸ›¡ï¸ Enhanced error handling and categorization")
      println("   â€¢ ðŸ”— Optimized URL parsing and validation")
      println("   â€¢ ðŸ“Š Response object with JSON/text parsing")
      println("   â€¢ ðŸ§ª Comprehensive test coverage (19 tests)")
      println(
        "\nðŸ’¡ This library provides a Python requests-like experience in MoonBit!",
      )
    } catch {
      @allwefantasy/requests.RequestError::ConnectionError(msg) =>
        println("âš ï¸  Connection error: \{msg}")
      @allwefantasy/requests.RequestError::URLError(msg) =>
        println("âš ï¸  URL error: \{msg}")
      @allwefantasy/requests.RequestError::HTTPError(code, reason, url) =>
        println("âš ï¸  HTTP error \{code}: \{reason} for \{url}")
      @allwefantasy/requests.RequestError::Timeout(msg) =>
        println("âš ï¸  Timeout error: \{msg}")
      @allwefantasy/requests.RequestError::TooManyRedirects(msg) =>
        println("âš ï¸  Too many redirects: \{msg}")
      @allwefantasy/requests.RequestError::SSLError(msg) =>
        println("âš ï¸  SSL error: \{msg}")
      @allwefantasy/requests.RequestError::ContentDecodingError(msg) =>
        println("âš ï¸  Content decoding error: \{msg}")
      _ =>
        println(
          "âš ï¸  Some network requests failed (expected in restricted environments)",
        )
    }
  }) catch {
    _ => ()
  }
}
